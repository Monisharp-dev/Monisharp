<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verifying | Monisharp</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #fff;
      overflow: hidden;
    }
    .container {
      text-align: center;
      padding: 30px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(15px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.4);
      max-width: 400px;
      animation: fadeIn 1s ease-out;
    }
    .logo {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 20px;
      animation: pulse 2s infinite;
    }
    .message {
      font-size: 18px;
      margin-bottom: 20px;
      line-height: 1.6;
      animation: slideIn 1.2s ease-out;
    }
    .loader {
      border: 6px solid rgba(255, 255, 255, 0.2);
      border-top: 6px solid #fff;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      margin: 0 auto 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.9);} to { opacity: 1; transform: scale(1);} }
    @keyframes pulse { 0%,100% { transform: scale(1);} 50% { transform: scale(1.1);} }
    @keyframes slideIn { from { opacity: 0; transform: translateY(20px);} to { opacity: 1; transform: translateY(0);} }
    .note { font-size: 14px; color: #ddd; animation: fadeIn 2s ease-out; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">‚ú® Monisharp</div>
    <div class="loader"></div>
    <div class="message">
      Welcome back to Monisharp,<br>
      please hold on as we verify your account.<br><br>
      <strong>‚ö† Do not close or minimize the app.</strong>
    </div>
    <div class="note">Thank you for your patience üôè</div>
  </div>

  <script>
  // üîπ Generate plus-Id if not available
  function extractIdFromEmail(email) {
    const baseId = email.split("@")[0];
    const Id = `${baseId}plus`;
    console.log(`Extracted Id from email '${email}':`, Id);
    return Id;
  }

  function processStoredEmail() {
    const emailKey = "plus-email";
    const idKey = "plus-Id";

    const email = localStorage.getItem(emailKey);

    if (!email) {
      console.warn("No email found in localStorage. Cannot process Id.");
      return;
    }

    console.log(`Starting Id processing for stored email: ${email}`);

    const Id = extractIdFromEmail(email);

    if (localStorage.getItem(idKey) === Id) {
      console.log(`Id '${Id}' already exists in localStorage. Skipping.`);
      return;
    }

    // Save the Id locally using the correct key
    localStorage.setItem(idKey, Id);
    console.log(`Id '${Id}' saved in localStorage under key '${idKey}'.`);
  }

  document.addEventListener("DOMContentLoaded", function () {
    // Ensure plus-Id exists before anything else
    processStoredEmail();

    const API_LISTTWO = [
      "https://sheetdb.io/api/v1/3fhj4vu7fak0u",
      "https://sheetdb.io/api/v1/xsn258gcncwv8",
      "https://sheetdb.io/api/v1/a60myauvx0ay1",
      "https://sheetdb.io/api/v1/n5g98bqmjh72j"
    ];

    function showPopup(message, success = false, allowLink = false) {
      console.log("[Popup]", message);
      let popup = document.getElementById("retrieve-popup");
      if (!popup) {
        popup = document.createElement("div");
        popup.id = "retrieve-popup";
        popup.style.position = "fixed";
        popup.style.bottom = "20px";
        popup.style.left = "50%";
        popup.style.transform = "translateX(-50%)";
        popup.style.padding = "12px 18px";
        popup.style.borderRadius = "8px";
        popup.style.fontSize = "14px";
        popup.style.color = "#fff";
        popup.style.zIndex = "99999";
        popup.style.boxShadow = "0 4px 12px rgba(0,0,0,0.3)";
        document.body.appendChild(popup);
      }
      popup.style.background = success ? "#4caf50" : "#2196f3";

      if (allowLink) {
        popup.innerHTML = `${message}<br><a href="https://wa.me/2348146054930" target="_blank" style="color:yellow;text-decoration:underline;">Contact Admin</a>`;
      } else {
        popup.innerText = message;
      }

      popup.style.display = "block";
      // ‚ùå Removed auto-hide ‚Üí stays visible until redirect
    }

    const userId = localStorage.getItem("plus-Id");
    if (!userId) {
      console.error("[Error] No Id in localStorage.");
      showPopup("‚ùå No User ID found.", false, true);
      return;
    }
    console.log("[Process] Found userId:", userId);

    async function fetchAllRecords() {
      let allData = [];
      for (const api of API_LISTTWO) {
        try {
          console.log("[SheetDB] Fetching from:", api);
          const res = await fetch(api);
          const data = await res.json();
          const arr = Array.isArray(data) ? data : [data];
          console.log(`[SheetDB] Retrieved ${arr.length} records from ${api}`);
          allData = allData.concat(arr);
        } catch (err) {
          console.error("[Error] Fetch failed:", api, err);
        }
      }
      localStorage.setItem("temp-sheetdb-data", JSON.stringify(allData));
      return allData;
    }

    function findRecord(allData, userId) {
      return allData.find((row) => String(row.Id).trim() === String(userId).trim()) || null;
    }

    function isValidBase64(str) {
      if (!str) return false;
      const sanitized = str.replace(/[^A-Za-z0-9+/=]/g, "");
      return sanitized.length % 4 === 0;
    }

    function restoreLocalStorage(base64Data) {
      try {
        if (!isValidBase64(base64Data)) {
          showPopup("‚ùå Invalid Base64 data from API.", false);
          return false;
        }
        const jsonString = atob(base64Data.replace(/\s/g, ""));
        const data = JSON.parse(jsonString);
        for (let key in data) {
          localStorage.setItem(key, data[key]);
        }
        localStorage.removeItem("temp-sheetdb-data");
        showPopup("‚úÖ Data restored successfully!", true);
        return true;
      } catch (err) {
        console.error("[Error] Failed to decode/restore:", err);
        showPopup("‚ùå Decode failed.", false);
        return false;
      }
    }

    (async function runRestore() {
      showPopup("üîÑ Restoring...");
      try {
        const allData = await fetchAllRecords();
        const record = findRecord(allData, userId);

        if (!record || !record.qrCode) {
          console.warn("[Notice] No data found in API. Proceeding as validated.");
          showPopup("‚ö† No saved data found. Starting fresh...", true);
          setTimeout(() => {
            window.location.href = "plus-index.html";
          }, 3000);
          return;
        }

        const ok = restoreLocalStorage(record.qrCode);
        if (ok) {
          setTimeout(() => {
            window.location.href = "plus-index.html";
          }, 3000);
        } else {
          console.warn("[Notice] Data decode failed. Proceeding anyway.");
          showPopup("‚ö† Data invalid. Starting fresh...", true);
          setTimeout(() => {
            window.location.href = "plus-index.html";
          }, 3000);
        }
      } catch (err) {
        console.error("[Error] Main process failed:", err);
        showPopup("‚ö† System error, but proceeding...", true);
        setTimeout(() => {
          window.location.href = "plus-index.html";
        }, 3000);
      }
    })();
  });
  </script>
</body>
</html>